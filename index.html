<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Simple Karteikarten</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Simple Karteikarten">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      height: 100vh;
    }
    header {
      position: fixed;
      top: 10px;
      left: 16px;
      font-weight: bold;
      z-index: 10;
    }
    main {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .view {
      display: none;
      width: 90%;
      max-width: 420px;
      text-align: center;
    }
    .active { display: block; }
    .box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    button {
      padding: 12px;
      width: 100%;
      margin: 6px 0;
      font-size: 16px;
    }
    button:disabled {
      opacity: 0.5;
    }
    .row { display: flex; gap: 10px; }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .hint { color: red; }
    .success { color: green; }
    .stat { font-weight: bold; }
    .warn {
      color: #b00020;
      font-size: 14px;
      margin-top: 8px;
    }
  </style>
</head>

<body>

<header>Simple Karteikarten</header>

<main>

<!-- START -->
<div id="home" class="view active">
  <button onclick="startPractice()">Üben</button>
  <button onclick="goAddQuestion()">Neue Karteikarte anlegen</button>
  <button onclick="importCards()">Import</button>
  <p id="homeHint" class="hint"></p>
</div>

<!-- FRAGE -->
<div id="add-question" class="view">
  <div class="box">
    <input id="questionInput" placeholder="Frage eingeben">
    <button onclick="saveQuestion()">Speichern & zur Antwort</button>
  </div>
</div>

<!-- ANTWORT -->
<div id="add-answer" class="view">
  <div class="box">
    <textarea id="answerInput" placeholder="Antwort eingeben"></textarea>
    <div class="row">
      <button id="saveNextBtn" onclick="saveCard(true)">Speichern & nächste Frage</button>
      <button onclick="saveCard(false)">Speichern & zur Startansicht</button>
    </div>
  </div>
</div>

<!-- ÜBEN -->
<div id="practice" class="view">
  <div class="box">
    <p id="cardText"></p>
    <button id="nextBtn" onclick="showAnswer()">Weiter</button>
    <div id="answerButtons" style="display:none;">
      <div class="row">
        <button onclick="answerCard(true)">Gewusst</button>
        <button onclick="answerCard(false)">Nicht gewusst</button>
      </div>
    </div>
    <p id="practiceWarn" class="warn"></p>
  </div>
</div>

<!-- ENDE -->
<div id="end" class="view">
  <p id="statText" class="stat"></p>
  <p id="endHint" class="hint"></p>
  <button onclick="exportCards()">Fragen & Antworten exportieren</button>
  <button onclick="showView('home')">Zurück zur Startansicht</button>
  <button id="againBtn" onclick="startPractice()">Noch ein Durchgang</button>
</div>

</main>

<script>
/* ================= KONSTANTEN ================= */
const KEY = "simple-karteikarten";
const MAX_CARDS = 30;

/* ================= STATE ================= */
let cards = JSON.parse(localStorage.getItem(KEY) || "[]");

let practiceCards = [];
let sessionResults = [];
let practiceActive = false;

let index = 0;
let tempQuestion = "";
let totalQuestions = 0;
let knownAnswers = 0;

/* ================= VIEW ================= */
function showView(id) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ================= START / LIMIT ================= */
function goAddQuestion() {
  if (cards.length >= MAX_CARDS) {
    homeHint.textContent =
      "Limit von 30 Karten erreicht, bitte zuerst Übung machen.";
    return;
  }
  homeHint.textContent = "";
  showView("add-question");
}

/* ================= ANLEGEN ================= */
function saveQuestion() {
  tempQuestion = questionInput.value.trim();
  if (!tempQuestion) return;
  questionInput.value = "";
  showView("add-answer");

  // Button-Status prüfen
  saveNextBtn.disabled = cards.length + 1 >= MAX_CARDS;
}

function saveCard(next) {
  const a = answerInput.value.trim();
  if (!a) return;

  if (cards.length < MAX_CARDS) {
    cards.push({ question: tempQuestion, answer: a, streak: 0 });
    localStorage.setItem(KEY, JSON.stringify(cards));
  }

  answerInput.value = "";
  showView(next ? "add-question" : "home");
}

/* ================= ÜBEN ================= */
function startPractice() {
  if (cards.length < 2) {
    homeHint.textContent = "Bitte mindestens zwei Karten anlegen";
    return;
  }

  homeHint.textContent = "";
  practiceCards = cards.map(c => ({ ...c }));
  sessionResults = [];
  practiceActive = true;

  index = 0;
  knownAnswers = 0;
  totalQuestions = practiceCards.length;

  showView("practice");
  showQuestion();
}

function showQuestion() {
  if (index >= practiceCards.length) {
    endCheck();
    return;
  }

  cardText.textContent = practiceCards[index].question;
  nextBtn.style.display = "block";
  answerButtons.style.display = "none";

  practiceWarn.textContent =
    practiceActive && index < 3
      ? "⚠️ Hinweis: Wenn du die App jetzt schließt, wird dieser Durchgang nicht gespeichert."
      : "";
}

function showAnswer() {
  cardText.textContent = practiceCards[index].answer;
  nextBtn.style.display = "none";
  answerButtons.style.display = "block";
}

function answerCard(known) {
  const card = practiceCards[index];
  sessionResults.push({
    question: card.question,
    answer: card.answer,
    known
  });
  if (known) knownAnswers++;
  index++;
  showQuestion();
}

/* ================= ENDE ================= */
function endCheck() {
  sessionResults.forEach(r => {
    const real = cards.find(c =>
      c.question === r.question && c.answer === r.answer
    );
    if (!real) return;
    real.streak = r.known ? real.streak + 1 : 0;
  });

  cards = cards.filter(c => c.streak < 2);
  localStorage.setItem(KEY, JSON.stringify(cards));

  practiceActive = false;

  showView("end");
  statText.textContent =
    `Du hast ${knownAnswers} von ${totalQuestions} Fragen gewusst (richtig beantwortet).`;

  againBtn.style.display = cards.length >= 2 ? "block" : "none";
  endHint.textContent =
    cards.length < 2
      ? "Bitte mindestens zwei Karten anlegen & Zurück zur Startansicht drücken"
      : "";
}

/* ================= EXPORT ================= */
function exportCards() {
  const data = cards.map(c => ({ question: c.question, answer: c.answer }));
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "simple-karteikarten-export.json";
  a.click();
}

/* ================= IMPORT ================= */
function importCards() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      let parsed;
      try {
        parsed = JSON.parse(reader.result);
      } catch {
        homeHint.textContent = "Import fehlgeschlagen.";
        return;
      }

      const freeSlots = MAX_CARDS - cards.length;
      if (freeSlots <= 0) {
        homeHint.textContent =
          "Limit von 30 Karten erreicht, bitte zuerst Übung machen.";
        return;
      }

      const valid = parsed.filter(c =>
        typeof c.question === "string" &&
        typeof c.answer === "string" &&
        c.question.trim() && c.answer.trim()
      );

      const toImport = valid.slice(0, freeSlots);
      toImport.forEach(c =>
        cards.push({ question: c.question.trim(), answer: c.answer.trim(), streak: 0 })
      );

      localStorage.setItem(KEY, JSON.stringify(cards));
      homeHint.textContent =
        `${toImport.length} Karten importiert${valid.length > freeSlots ? " (Limit erreicht)" : ""}.`;
      homeHint.className = "success";
    };

    reader.readAsText(file);
  };

  input.click();
}

/* ================= SERVICE WORKER ================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
